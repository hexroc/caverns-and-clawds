<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Dreadnought's Depths - Capstone Dungeon</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* ABYSSAL DEPTHS THEME */
      --bg-abyss: #05080f;
      --bg-deep: #0a1018;
      --bg-panel: #0d1520;
      --bg-lighter: #121d2d;
      --accent-gold: #d4af37;
      --accent-gold-glow: rgba(212, 175, 55, 0.4);
      --accent-purple: #8b5cf6;
      --accent-purple-glow: rgba(139, 92, 246, 0.3);
      --accent-blue: #3b82f6;
      --accent-cyan: #22d3ee;
      --text: #e8f0f8;
      --text-muted: #6b7a8c;
      --danger: #ef4444;
      --danger-glow: rgba(239, 68, 68, 0.4);
      --success: #22c55e;
      --warning: #f59e0b;
      --border: #1e3a5f;
      --border-glow: #2d5a8f;

      /* Boss colors */
      --phase1: #4ade80;
      --phase2: #facc15;
      --phase3: #ef4444;
    }

    body {
      background: var(--bg-abyss);
      color: var(--text);
      font-family: 'Georgia', serif;
      overflow: hidden;
      height: 100vh;
    }

    /* ===== MAIN LAYOUT ===== */
    .capstone-layout {
      display: grid;
      grid-template-rows: 60px 1fr 180px;
      height: 100vh;
    }

    .main-content {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      overflow: hidden;
    }

    /* ===== HEADER ===== */
    .header {
      display: flex;
      align-items: center;
      padding: 0 24px;
      background: linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-abyss) 100%);
      border-bottom: 2px solid var(--border);
      gap: 20px;
    }

    .back-btn {
      color: var(--accent-cyan);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      background: rgba(34, 211, 238, 0.1);
      border: 1px solid rgba(34, 211, 238, 0.3);
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: rgba(34, 211, 238, 0.2);
    }

    .dungeon-title {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dungeon-title h1 {
      font-size: 1.4rem;
      color: var(--accent-gold);
      text-shadow: 0 0 20px var(--accent-gold-glow);
    }

    .dungeon-title .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .floor-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
    }

    .floor-indicator .icon { font-size: 1.2rem; }
    .floor-indicator .text {
      font-size: 0.9rem;
      color: var(--accent-purple);
    }

    .death-counter {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
    }

    .death-counter .skulls {
      font-size: 1.1rem;
      letter-spacing: 4px;
    }

    .death-counter .text {
      font-size: 0.85rem;
      color: var(--danger);
    }

    .connection-status {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .connection-status.connected { color: var(--success); }
    .connection-status.connecting { color: var(--warning); }
    .connection-status.disconnected { color: var(--danger); }

    /* ===== LEFT PANEL - PARTY STATUS ===== */
    .party-panel {
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }

    .panel-header h3 {
      font-size: 1rem;
      color: var(--accent-gold);
    }

    .party-member {
      background: var(--bg-lighter);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.3s;
    }

    .party-member.current-turn {
      border-color: var(--accent-gold);
      box-shadow: 0 0 15px var(--accent-gold-glow);
    }

    .party-member.dead {
      opacity: 0.5;
      filter: grayscale(0.8);
    }

    .party-member-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .member-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-deep);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-size: 0.95rem;
      font-weight: bold;
      color: var(--text);
    }

    .member-class {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .hp-bar-container {
      margin-top: 8px;
    }

    .hp-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .hp-bar {
      height: 8px;
      background: var(--bg-deep);
      border-radius: 4px;
      overflow: hidden;
    }

    .hp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--danger) 0%, var(--success) 100%);
      transition: width 0.5s ease, background 0.3s;
      border-radius: 4px;
    }

    .hp-bar-fill.critical {
      background: var(--danger);
      animation: pulse-critical 1s infinite;
    }

    @keyframes pulse-critical {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .conditions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }

    .condition-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent-purple);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .condition-tag.negative {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.3);
    }

    /* ===== CENTER - ROOM/COMBAT VIEW ===== */
    .center-panel {
      position: relative;
      background: var(--bg-deep);
      overflow: hidden;
    }

    /* Room View (non-combat) */
    .room-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
    }

    .no-instance-view.hidden { display: none; }
    .room-view.hidden { display: none; }

    .room-type-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 20px var(--accent-gold-glow));
    }

    .room-name {
      font-size: 2rem;
      color: var(--accent-gold);
      margin-bottom: 12px;
      text-shadow: 0 0 30px var(--accent-gold-glow);
    }

    .room-description {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 500px;
      line-height: 1.6;
    }

    .room-exits {
      margin-top: 24px;
      display: flex;
      gap: 12px;
    }

    .exit-badge {
      padding: 8px 16px;
      background: rgba(34, 211, 238, 0.1);
      border: 1px solid rgba(34, 211, 238, 0.3);
      border-radius: 6px;
      color: var(--accent-cyan);
      font-size: 0.85rem;
    }

    /* Combat Grid View */
    .combat-view {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .combat-view.hidden { display: none; }

    .hex-grid-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hex-grid-ascii {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.1;
      white-space: pre;
      color: var(--text);
      background: var(--bg-abyss);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    /* Canvas-based hex grid */
    #hex-canvas {
      width: 100%;
      height: 100%;
    }

    /* Combat UI Overlay */
    .combat-ui {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .combat-ui > * { pointer-events: auto; }

    .turn-indicator {
      background: rgba(10, 16, 24, 0.95);
      border: 2px solid var(--accent-gold);
      border-radius: 8px;
      padding: 12px 20px;
      box-shadow: 0 0 20px var(--accent-gold-glow);
    }

    .turn-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .turn-name {
      font-size: 1.2rem;
      color: var(--accent-gold);
      font-weight: bold;
    }

    .turn-timer {
      margin-top: 8px;
      height: 4px;
      background: var(--bg-deep);
      border-radius: 2px;
      overflow: hidden;
    }

    .turn-timer-fill {
      height: 100%;
      background: var(--accent-gold);
      transition: width 0.1s linear;
    }

    .round-indicator {
      background: rgba(10, 16, 24, 0.9);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* Boss Phase UI */
    .boss-phase-ui {
      position: absolute;
      top: 16px;
      right: 340px;
      background: rgba(10, 16, 24, 0.95);
      border: 2px solid var(--phase1);
      border-radius: 8px;
      padding: 12px 20px;
      min-width: 180px;
    }

    .boss-phase-ui.phase-2 { border-color: var(--phase2); }
    .boss-phase-ui.phase-3 { border-color: var(--phase3); }

    .boss-name {
      font-size: 1.1rem;
      color: var(--danger);
      font-weight: bold;
      margin-bottom: 8px;
    }

    .boss-hp-bar {
      height: 12px;
      background: var(--bg-deep);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .boss-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--danger) 0%, var(--phase2) 50%, var(--phase1) 100%);
      transition: width 0.5s ease;
    }

    .boss-phase {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .boss-phase .phase-name {
      color: var(--phase1);
      font-weight: bold;
    }

    .boss-phase-ui.phase-2 .phase-name { color: var(--phase2); }
    .boss-phase-ui.phase-3 .phase-name { color: var(--phase3); }

    /* Phase Transition Overlay */
    .phase-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }

    .phase-transition-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .phase-transition-content {
      text-align: center;
      animation: phaseShake 0.5s ease;
    }

    @keyframes phaseShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .phase-transition-icon {
      font-size: 6rem;
      margin-bottom: 20px;
      animation: phasePulse 1s infinite;
    }

    @keyframes phasePulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.1); filter: brightness(1.5); }
    }

    .phase-transition-text {
      font-size: 2.5rem;
      color: var(--danger);
      text-shadow: 0 0 40px var(--danger-glow);
      margin-bottom: 12px;
    }

    .phase-transition-desc {
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    /* ===== RIGHT PANEL - COMBAT LOG ===== */
    .log-panel {
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .log-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .log-header h3 {
      font-size: 1rem;
      color: var(--accent-gold);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-tabs {
      display: flex;
      gap: 4px;
    }

    .log-tab {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .log-tab:hover, .log-tab.active {
      background: var(--bg-lighter);
      color: var(--text);
      border-color: var(--accent-cyan);
    }

    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .log-entry {
      padding: 8px 12px;
      background: var(--bg-lighter);
      border-radius: 6px;
      border-left: 3px solid var(--border);
      animation: logSlideIn 0.3s ease;
    }

    @keyframes logSlideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .log-entry.attack { border-left-color: var(--danger); }
    .log-entry.damage { border-left-color: #f97316; }
    .log-entry.heal { border-left-color: var(--success); }
    .log-entry.move { border-left-color: var(--accent-blue); }
    .log-entry.critical { border-left-color: var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
    .log-entry.death { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.15); }
    .log-entry.phase { border-left-color: var(--accent-purple); background: rgba(139, 92, 246, 0.1); }
    .log-entry.system { border-left-color: var(--text-muted); }

    .log-time {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .log-text {
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .log-highlight {
      color: var(--accent-gold);
      font-weight: bold;
    }

    .log-damage {
      color: var(--danger);
      font-weight: bold;
    }

    .log-heal {
      color: var(--success);
      font-weight: bold;
    }

    /* ===== BOTTOM - ACTION BAR ===== */
    .action-bar {
      background: var(--bg-panel);
      border-top: 2px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .instance-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .instance-selector label {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .instance-selector select {
      background: var(--bg-lighter);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      min-width: 200px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: 2px solid var(--border);
      background: var(--bg-lighter);
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-btn:hover:not(:disabled) {
      background: var(--bg-deep);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, var(--accent-gold) 0%, #b8860b 100%);
      border-color: var(--accent-gold);
      color: #000;
      font-weight: bold;
    }

    .action-btn.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #f4cf57 0%, var(--accent-gold) 100%);
    }

    .action-btn.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .action-btn.danger:hover:not(:disabled) {
      background: rgba(239, 68, 68, 0.2);
    }

    .spectator-badge {
      padding: 8px 16px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 6px;
      color: var(--accent-purple);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ===== OVERLAYS ===== */
    .victory-overlay, .defeat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }

    .victory-overlay.active, .defeat-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .victory-overlay {
      background: radial-gradient(ellipse at center, rgba(212, 175, 55, 0.3) 0%, rgba(5, 8, 15, 0.95) 70%);
    }

    .defeat-overlay {
      background: radial-gradient(ellipse at center, rgba(239, 68, 68, 0.3) 0%, rgba(5, 8, 15, 0.95) 70%);
    }

    .overlay-content {
      text-align: center;
      animation: overlayPop 0.5s ease;
    }

    @keyframes overlayPop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .overlay-icon {
      font-size: 8rem;
      margin-bottom: 20px;
    }

    .victory-overlay .overlay-icon { animation: victoryGlow 2s infinite; }
    
    @keyframes victoryGlow {
      0%, 100% { filter: drop-shadow(0 0 20px var(--accent-gold-glow)); }
      50% { filter: drop-shadow(0 0 40px var(--accent-gold)); }
    }

    .overlay-title {
      font-size: 3.5rem;
      margin-bottom: 16px;
    }

    .victory-overlay .overlay-title {
      color: var(--accent-gold);
      text-shadow: 0 0 40px var(--accent-gold-glow);
    }

    .defeat-overlay .overlay-title {
      color: var(--danger);
      text-shadow: 0 0 40px var(--danger-glow);
    }

    .overlay-subtitle {
      font-size: 1.3rem;
      color: var(--text-muted);
      margin-bottom: 30px;
    }

    .rewards-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 30px;
    }

    .reward-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .reward-item .icon { font-size: 1.5rem; }
    .reward-item .value { color: var(--accent-gold); font-weight: bold; }

    /* ===== NO INSTANCE VIEW ===== */
    .no-instance-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .no-instance-icon {
      font-size: 5rem;
      margin-bottom: 24px;
      opacity: 0.5;
    }

    .no-instance-title {
      font-size: 1.8rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .no-instance-text {
      color: var(--text-muted);
      max-width: 400px;
      line-height: 1.6;
    }

    .active-instances {
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 500px;
    }

    .instance-card {
      background: var(--bg-lighter);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .instance-card:hover {
      border-color: var(--accent-gold);
      box-shadow: 0 0 15px var(--accent-gold-glow);
    }

    .instance-card .icon { font-size: 2rem; }
    .instance-card .info { flex: 1; }
    .instance-card .leader { font-weight: bold; color: var(--accent-gold); }
    .instance-card .details { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }

    /* ===== DAMAGE NUMBERS ===== */
    .damage-number {
      position: fixed;
      font-size: 1.5rem;
      font-weight: bold;
      pointer-events: none;
      animation: damageFloat 1.5s ease-out forwards;
      z-index: 1500;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .damage-number.damage { color: var(--danger); }
    .damage-number.heal { color: var(--success); }
    .damage-number.critical { 
      color: var(--accent-gold); 
      font-size: 2rem;
      animation: criticalFloat 1.5s ease-out forwards;
    }

    @keyframes damageFloat {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-60px) scale(0.8); }
    }

    @keyframes criticalFloat {
      0% { opacity: 1; transform: translateY(0) scale(1.5); }
      20% { transform: translateY(-10px) scale(1.8); }
      100% { opacity: 0; transform: translateY(-80px) scale(1); }
    }

    /* ===== SCREEN SHAKE ===== */
    .screen-shake {
      animation: screenShake 0.5s ease;
    }

    @keyframes screenShake {
      0%, 100% { transform: translate(0); }
      10%, 30%, 50%, 70%, 90% { transform: translate(-3px, 2px); }
      20%, 40%, 60%, 80% { transform: translate(3px, -2px); }
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-deep);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-glow);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 220px 1fr 280px;
      }
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .party-panel, .log-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="capstone-layout">
    <!-- HEADER -->
    <header class="header">
      <a href="/" class="back-btn">‚Üê Lobby</a>
      
      <div class="dungeon-title">
        <h1 id="dungeon-name">ü¶Ä The Dreadnought's Depths</h1>
        <span class="subtitle" id="dungeon-status">Select a capstone to spectate</span>
      </div>
      
      <div class="floor-indicator">
        <span class="icon">üèöÔ∏è</span>
        <span class="text">Floor <span id="current-floor">-</span> / Room <span id="current-room">-</span></span>
      </div>
      
      <div class="death-counter">
        <span class="skulls" id="death-skulls">‚ö™‚ö™‚ö™</span>
        <span class="text"><span id="deaths-remaining">3</span> lives</span>
      </div>
      
      <div class="connection-status connecting" id="connection-status">üü° Connecting...</div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- LEFT PANEL - PARTY -->
      <div class="party-panel">
        <div class="panel-header">
          <span>üë•</span>
          <h3>Party</h3>
        </div>
        <div id="party-list">
          <!-- Party members will be rendered here -->
          <div class="party-member">
            <div class="party-member-header">
              <div class="member-icon">ü¶û</div>
              <div class="member-info">
                <div class="member-name">Waiting...</div>
                <div class="member-class">Select a capstone</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER - ROOM/COMBAT VIEW -->
      <div class="center-panel">
        <!-- No instance selected -->
        <div class="no-instance-view" id="no-instance-view">
          <div class="no-instance-icon">ü¶Ä</div>
          <h2 class="no-instance-title">No Active Capstone</h2>
          <p class="no-instance-text">
            Select an active capstone dungeon from the list below to spectate, 
            or start your own adventure in the game.
          </p>
          <div class="active-instances" id="active-instances">
            <!-- Active instances will be listed here -->
          </div>
        </div>

        <!-- Room view (non-combat) -->
        <div class="room-view hidden" id="room-view">
          <div class="room-type-icon" id="room-type-icon">‚öîÔ∏è</div>
          <h2 class="room-name" id="room-name">Combat Room</h2>
          <p class="room-description" id="room-description">
            Enemies lurk in the darkness ahead.
          </p>
          <div class="room-exits" id="room-exits">
            <span class="exit-badge">‚Üí Forward</span>
          </div>
        </div>

        <!-- Combat view -->
        <div class="combat-view hidden" id="combat-view">
          <div class="hex-grid-container" id="hex-grid-container">
            <canvas id="hex-canvas"></canvas>
          </div>
          
          <!-- Combat UI -->
          <div class="combat-ui">
            <div class="turn-indicator" id="turn-indicator">
              <div class="turn-label">Current Turn</div>
              <div class="turn-name" id="turn-name">-</div>
              <div class="turn-timer">
                <div class="turn-timer-fill" id="turn-timer-fill" style="width: 100%"></div>
              </div>
            </div>
            <div class="round-indicator">Round <span id="round-number">1</span></div>
          </div>
          
          <!-- Boss UI (when fighting boss) -->
          <div class="boss-phase-ui hidden" id="boss-phase-ui">
            <div class="boss-name" id="boss-name">The Dreadnought</div>
            <div class="boss-hp-bar">
              <div class="boss-hp-fill" id="boss-hp-fill" style="width: 100%"></div>
            </div>
            <div class="boss-phase">Phase: <span class="phase-name" id="boss-phase-name">Normal</span></div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL - COMBAT LOG -->
      <div class="log-panel">
        <div class="log-header">
          <h3>üìú Combat Log</h3>
          <div class="log-tabs">
            <button class="log-tab active" data-filter="all">All</button>
            <button class="log-tab" data-filter="combat">‚öîÔ∏è</button>
            <button class="log-tab" data-filter="system">üì¢</button>
          </div>
        </div>
        <div class="log-content" id="log-content">
          <div class="log-entry system">
            <div class="log-time">--:--</div>
            <div class="log-text">Connecting to dungeon...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTTOM - ACTION BAR -->
    <div class="action-bar">
      <div class="instance-selector">
        <label for="instance-select">Instance:</label>
        <select id="instance-select">
          <option value="">Select a capstone...</option>
        </select>
        <button class="action-btn" onclick="refreshInstances()">üîÑ Refresh</button>
      </div>
      
      <div class="action-buttons" id="action-buttons">
        <!-- Player actions (shown when it's your turn) -->
        <button class="action-btn" id="btn-attack" disabled onclick="sendAction('attack')">‚öîÔ∏è Attack</button>
        <button class="action-btn" id="btn-move" disabled onclick="sendAction('move')">üëü Move</button>
        <button class="action-btn" id="btn-dodge" disabled onclick="sendAction('dodge')">üõ°Ô∏è Dodge</button>
        <button class="action-btn" id="btn-ability" disabled onclick="sendAction('ability')">‚ú® Ability</button>
        <button class="action-btn primary" id="btn-end-turn" disabled onclick="sendAction('end_turn')">‚è≠Ô∏è End Turn</button>
      </div>
      
      <div class="spectator-badge">
        <span>üëÅÔ∏è</span>
        <span id="spectator-count">0</span>
        <span>watching</span>
      </div>
    </div>
  </div>

  <!-- Phase Transition Overlay -->
  <div class="phase-transition-overlay" id="phase-overlay">
    <div class="phase-transition-content">
      <div class="phase-transition-icon">ü¶Ä</div>
      <div class="phase-transition-text" id="phase-text">PHASE 2: REGENERATING</div>
      <div class="phase-transition-desc" id="phase-desc">The Dreadnought's shell begins to pulse with dark energy!</div>
    </div>
  </div>

  <!-- Victory Overlay -->
  <div class="victory-overlay" id="victory-overlay">
    <div class="overlay-content">
      <div class="overlay-icon">üëë</div>
      <h1 class="overlay-title">VICTORY!</h1>
      <p class="overlay-subtitle">The Dreadnought Has Been Defeated!</p>
      <div class="rewards-list" id="victory-rewards">
        <div class="reward-item">
          <span class="icon">‚≠ê</span>
          <span>XP: <span class="value">1000</span></span>
        </div>
        <div class="reward-item">
          <span class="icon">üíé</span>
          <span>Pearls: <span class="value">500</span></span>
        </div>
        <div class="reward-item">
          <span class="icon">üèÜ</span>
          <span>Achievement: <span class="value">Dreadnought Slayer</span></span>
        </div>
      </div>
      <button class="action-btn primary" onclick="closeOverlays()">Continue</button>
    </div>
  </div>

  <!-- Defeat Overlay -->
  <div class="defeat-overlay" id="defeat-overlay">
    <div class="overlay-content">
      <div class="overlay-icon">üíÄ</div>
      <h1 class="overlay-title">DEFEATED</h1>
      <p class="overlay-subtitle" id="defeat-message">The Dreadnought's Depths claims more souls...</p>
      <button class="action-btn" onclick="closeOverlays()">Return to Lobby</button>
    </div>
  </div>

  <!-- Damage Numbers Container -->
  <div id="damage-numbers"></div>

  <script>
    // ========================================
    // STATE
    // ========================================
    let currentCapstoneId = null;
    let currentCombat = null;
    let ws = null;
    let pollInterval = null;
    let timerInterval = null;
    let turnStartTime = null;
    const TURN_DURATION = 10000;
    const API_KEY = localStorage.getItem('cnc_api_key') || '';

    // Room type icons
    const ROOM_ICONS = {
      combat: '‚öîÔ∏è',
      trap: '‚ö†Ô∏è',
      rest: 'üèïÔ∏è',
      treasure: 'üíé',
      puzzle: 'üß©',
      stairs: 'ü™ú',
      boss: 'ü¶Ä'
    };

    // ========================================
    // INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      initWebSocket();
      refreshInstances();
      
      // Instance selector change
      document.getElementById('instance-select').addEventListener('change', (e) => {
        if (e.target.value) {
          selectCapstone(e.target.value);
        }
      });
      
      // Log tab filters
      document.querySelectorAll('.log-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.log-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          filterLogs(tab.dataset.filter);
        });
      });
      
      // Check URL params for capstone ID
      const urlParams = new URLSearchParams(window.location.search);
      const capstoneId = urlParams.get('id');
      if (capstoneId) {
        selectCapstone(capstoneId);
      }
    });

    // ========================================
    // WEBSOCKET
    // ========================================
    function initWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);
      
      ws.onopen = () => {
        updateConnectionStatus('connected');
        addLogEntry('Connected to server', 'system');
        
        if (currentCapstoneId) {
          ws.send(JSON.stringify({ type: 'subscribe_capstone', capstoneId: currentCapstoneId }));
        }
      };
      
      ws.onclose = () => {
        updateConnectionStatus('disconnected');
        addLogEntry('Disconnected from server', 'system');
        setTimeout(initWebSocket, 3000);
      };
      
      ws.onerror = () => {
        updateConnectionStatus('disconnected');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (e) {
          console.error('WebSocket message error:', e);
        }
      };
    }

    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'combat_event':
          handleCombatEvent(data.event);
          break;
        case 'spectators':
          document.getElementById('spectator-count').textContent = data.count;
          break;
        case 'capstone_update':
          if (data.capstoneId === currentCapstoneId) {
            fetchRoomState();
          }
          break;
      }
    }

    function updateConnectionStatus(status) {
      const el = document.getElementById('connection-status');
      el.className = `connection-status ${status}`;
      el.textContent = status === 'connected' ? 'üü¢ Live' : 
                       status === 'connecting' ? 'üü° Connecting...' : 'üî¥ Disconnected';
    }

    // ========================================
    // API CALLS
    // ========================================
    async function fetchAPI(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (API_KEY) headers['X-API-Key'] = API_KEY;
      
      const res = await fetch(`/api/capstone${endpoint}`, { ...options, headers });
      return res.json();
    }

    async function refreshInstances() {
      const data = await fetchAPI('/active');
      const select = document.getElementById('instance-select');
      const container = document.getElementById('active-instances');
      
      select.innerHTML = '<option value="">Select a capstone...</option>';
      container.innerHTML = '';
      
      if (data.success && data.capstones.length > 0) {
        data.capstones.forEach(c => {
          // Add to dropdown
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = `${c.leader}'s Party - Floor ${c.currentFloor}`;
          select.appendChild(option);
          
          // Add to instance cards
          const card = document.createElement('div');
          card.className = 'instance-card';
          card.onclick = () => selectCapstone(c.id);
          card.innerHTML = `
            <div class="icon">ü¶Ä</div>
            <div class="info">
              <div class="leader">${c.leader}'s Party</div>
              <div class="details">Floor ${c.currentFloor} ‚Ä¢ Room ${c.currentRoom} ‚Ä¢ ${c.partySize} members ‚Ä¢ ${c.deathCount}/3 deaths</div>
            </div>
          `;
          container.appendChild(card);
        });
      } else {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No active capstones. Be the first to venture into The Dreadnought\'s Depths!</p>';
      }
    }

    async function selectCapstone(id) {
      console.log('selectCapstone called with id:', id);
      currentCapstoneId = id;
      document.getElementById('instance-select').value = id;
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('id', id);
      window.history.replaceState({}, '', url);
      
      // Subscribe via WebSocket
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'subscribe_capstone', capstoneId: id }));
      }
      
      // Start polling
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(fetchRoomState, 2000);
      
      // Fetch initial state
      console.log('Fetching room state...');
      await fetchRoomState();
      console.log('Room state fetched');
      
      // Hide no-instance view
      document.getElementById('no-instance-view').classList.add('hidden');
    }

    async function fetchRoomState() {
      if (!currentCapstoneId) {
        console.log('No capstone ID set');
        return;
      }
      
      // Use public spectate endpoint (no auth required)
      console.log('Fetching from:', `/spectate/${currentCapstoneId}/room`);
      try {
        const data = await fetchAPI(`/spectate/${currentCapstoneId}/room`);
        console.log('Room data:', data);
        if (!data.success) {
          console.error('Room fetch failed:', data.error);
          return;
        }
      
        updateHeader(data);
        updateParty(data.combat?.combatants || []);
      
        if (data.combat) {
          showCombatView(data.combat);
        } else {
          showRoomView(data.roomInfo);
        }
      } catch (err) {
        console.error('Error fetching room state:', err);
      }
    }

    // ========================================
    // UI UPDATES
    // ========================================
    function updateHeader(data) {
      document.getElementById('current-floor').textContent = data.floor || '-';
      document.getElementById('current-room').textContent = data.room || '-';
      document.getElementById('deaths-remaining').textContent = data.deathsRemaining || 3;
      
      // Update death skulls
      const deaths = data.deathCount || 0;
      const skulls = 'üíÄ'.repeat(deaths) + '‚ö™'.repeat(3 - deaths);
      document.getElementById('death-skulls').textContent = skulls;
      
      // Update status
      const status = data.combat ? 'In Combat!' : data.roomInfo?.name || 'Exploring...';
      document.getElementById('dungeon-status').textContent = status;
    }

    function updateParty(combatants) {
      const partyList = document.getElementById('party-list');
      const party = combatants.filter(c => c.team === 'party');
      
      if (party.length === 0) {
        partyList.innerHTML = `
          <div class="party-member">
            <div class="party-member-header">
              <div class="member-icon">ü¶û</div>
              <div class="member-info">
                <div class="member-name">Loading...</div>
                <div class="member-class">Fetching party data</div>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      partyList.innerHTML = party.map(member => {
        const hpPercent = Math.round((member.hp / member.maxHp) * 100);
        const isCritical = hpPercent < 25;
        const isDead = !member.isAlive;
        const isCurrent = currentCombat?.currentTurn?.id === member.id;
        
        return `
          <div class="party-member ${isCurrent ? 'current-turn' : ''} ${isDead ? 'dead' : ''}">
            <div class="party-member-header">
              <div class="member-icon">${member.char || 'ü¶û'}</div>
              <div class="member-info">
                <div class="member-name">${member.name}</div>
                <div class="member-class">${member.type}</div>
              </div>
            </div>
            <div class="hp-bar-container">
              <div class="hp-bar-label">
                <span>‚ù§Ô∏è HP</span>
                <span>${member.hp}/${member.maxHp}</span>
              </div>
              <div class="hp-bar">
                <div class="hp-bar-fill ${isCritical ? 'critical' : ''}" style="width: ${hpPercent}%"></div>
              </div>
            </div>
            ${member.conditions?.length ? `
              <div class="conditions">
                ${member.conditions.map(c => `
                  <span class="condition-tag ${['poisoned', 'frightened', 'stunned'].includes(c) ? 'negative' : ''}">${c}</span>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function showRoomView(roomInfo) {
      if (!roomInfo) return;
      
      document.getElementById('combat-view').classList.add('hidden');
      document.getElementById('room-view').classList.remove('hidden');
      
      const icon = ROOM_ICONS[roomInfo.type] || '‚ùì';
      document.getElementById('room-type-icon').textContent = icon;
      document.getElementById('room-name').textContent = roomInfo.name || 'Unknown Room';
      document.getElementById('room-description').textContent = roomInfo.description || '';
      
      // Show exits
      const exitsDiv = document.getElementById('room-exits');
      const exits = [];
      if (roomInfo.room < 5) exits.push('‚Üí Forward');
      if (roomInfo.room > 1) exits.push('‚Üê Back');
      if (roomInfo.type === 'stairs') exits.push('‚Üì Descend');
      
      exitsDiv.innerHTML = exits.map(e => `<span class="exit-badge">${e}</span>`).join('');
      
      currentCombat = null;
    }

    function showCombatView(combat) {
      document.getElementById('room-view').classList.add('hidden');
      document.getElementById('combat-view').classList.remove('hidden');
      
      currentCombat = combat;
      
      // Update turn indicator
      if (combat.currentTurn) {
        document.getElementById('turn-name').textContent = combat.currentTurn.name;
        startTurnTimer();
      }
      
      document.getElementById('round-number').textContent = combat.round || 1;
      
      // Render hex grid
      renderHexGrid(combat);
      
      // Show boss UI if boss present
      const boss = combat.combatants?.find(c => c.type === 'boss');
      if (boss) {
        showBossUI(boss, combat);
      } else {
        document.getElementById('boss-phase-ui').classList.add('hidden');
      }
      
      // Update action buttons
      updateActionButtons(combat);
    }

    function renderHexGrid(combat) {
      const canvas = document.getElementById('hex-canvas');
      const container = document.getElementById('hex-grid-container');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
      
      const HEX_SIZE = 28;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      
      // Clear
      ctx.fillStyle = '#05080f';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Get grid data
      const grid = combat.grid || {};
      const combatants = combat.combatants || [];
      
      // Draw hex grid (simple version)
      const range = 10;
      for (let q = -range; q <= range; q++) {
        for (let r = Math.max(-range, -q - range); r <= Math.min(range, -q + range); r++) {
          const px = centerX + HEX_SIZE * (Math.sqrt(3) * q + Math.sqrt(3)/2 * r);
          const py = centerY + HEX_SIZE * (3/2 * r);
          
          drawHex(ctx, px, py, HEX_SIZE - 2, '#1e3a5f', '#0d1520');
        }
      }
      
      // Draw combatants
      combatants.forEach(c => {
        if (!c.position || !c.isAlive) return;
        
        const px = centerX + HEX_SIZE * (Math.sqrt(3) * c.position.q + Math.sqrt(3)/2 * c.position.r);
        const py = centerY + HEX_SIZE * (3/2 * c.position.r);
        
        const color = c.team === 'party' ? '#22c55e' : c.type === 'boss' ? '#ef4444' : '#f97316';
        const fillColor = c.team === 'party' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';
        
        drawHex(ctx, px, py, HEX_SIZE - 2, color, fillColor);
        
        // Draw character icon
        ctx.font = `${HEX_SIZE}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(c.char || '‚óè', px, py);
        
        // Draw HP bar
        const hpPercent = c.hp / c.maxHp;
        const barWidth = HEX_SIZE * 1.5;
        const barX = px - barWidth / 2;
        const barY = py + HEX_SIZE * 0.8;
        
        ctx.fillStyle = '#1e3a5f';
        ctx.fillRect(barX, barY, barWidth, 4);
        
        ctx.fillStyle = hpPercent > 0.5 ? '#22c55e' : hpPercent > 0.25 ? '#f59e0b' : '#ef4444';
        ctx.fillRect(barX, barY, barWidth * hpPercent, 4);
      });
    }

    function drawHex(ctx, x, y, size, strokeColor, fillColor) {
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = (Math.PI / 3) * i - Math.PI / 6;
        const hx = x + size * Math.cos(angle);
        const hy = y + size * Math.sin(angle);
        if (i === 0) ctx.moveTo(hx, hy);
        else ctx.lineTo(hx, hy);
      }
      ctx.closePath();
      
      ctx.fillStyle = fillColor;
      ctx.fill();
      ctx.strokeStyle = strokeColor;
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    function showBossUI(boss, combat) {
      const ui = document.getElementById('boss-phase-ui');
      ui.classList.remove('hidden');
      
      document.getElementById('boss-name').textContent = boss.name;
      
      const hpPercent = Math.round((boss.hp / boss.maxHp) * 100);
      document.getElementById('boss-hp-fill').style.width = `${hpPercent}%`;
      
      // Determine phase
      let phase = 1;
      let phaseName = 'Normal';
      if (hpPercent <= 33) { phase = 3; phaseName = 'Berserk'; }
      else if (hpPercent <= 66) { phase = 2; phaseName = 'Regenerating'; }
      
      document.getElementById('boss-phase-name').textContent = phaseName;
      ui.className = `boss-phase-ui phase-${phase}`;
    }

    function startTurnTimer() {
      turnStartTime = Date.now();
      
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - turnStartTime;
        const remaining = Math.max(0, TURN_DURATION - elapsed);
        const percent = (remaining / TURN_DURATION) * 100;
        
        document.getElementById('turn-timer-fill').style.width = `${percent}%`;
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
        }
      }, 100);
    }

    function updateActionButtons(combat) {
      // For now, keep buttons disabled (spectator mode)
      // In player mode, enable based on whose turn it is
      const isMyTurn = false; // Would check if current user's turn
      
      document.getElementById('btn-attack').disabled = !isMyTurn;
      document.getElementById('btn-move').disabled = !isMyTurn;
      document.getElementById('btn-dodge').disabled = !isMyTurn;
      document.getElementById('btn-ability').disabled = !isMyTurn;
      document.getElementById('btn-end-turn').disabled = !isMyTurn;
    }

    // ========================================
    // COMBAT EVENTS
    // ========================================
    function handleCombatEvent(event) {
      switch (event.type) {
        case 'turn_start':
          addLogEntry(`${event.combatant?.name}'s turn begins`, 'system');
          if (currentCombat) {
            currentCombat.currentTurn = event.combatant;
            document.getElementById('turn-name').textContent = event.combatant?.name || '-';
            startTurnTimer();
          }
          break;
          
        case 'attack':
          const hitText = event.hit ? 
            `<span class="log-highlight">${event.attacker}</span> hits <span class="log-highlight">${event.target}</span>!` :
            `<span class="log-highlight">${event.attacker}</span> misses <span class="log-highlight">${event.target}</span>`;
          addLogEntry(hitText, 'attack');
          break;
          
        case 'damage':
          addLogEntry(
            `<span class="log-highlight">${event.target}</span> takes <span class="log-damage">${event.amount}</span> damage!`,
            event.critical ? 'critical' : 'damage'
          );
          spawnDamageNumber(event.amount, event.critical ? 'critical' : 'damage');
          if (event.critical) screenShake();
          break;
          
        case 'heal':
          addLogEntry(
            `<span class="log-highlight">${event.target}</span> heals <span class="log-heal">${event.amount}</span> HP`,
            'heal'
          );
          spawnDamageNumber(event.amount, 'heal');
          break;
          
        case 'death':
          addLogEntry(
            `üíÄ <span class="log-highlight">${event.combatant}</span> has fallen!`,
            'death'
          );
          screenShake();
          break;
          
        case 'phase_change':
          showPhaseTransition(event);
          addLogEntry(
            `‚ö° PHASE ${event.phase}: ${event.phaseName} - ${event.description}`,
            'phase'
          );
          break;
          
        case 'combat_end':
          if (event.result === 'victory') {
            showVictory(event);
          } else {
            showDefeat(event);
          }
          break;
          
        case 'round_start':
          addLogEntry(`--- Round ${event.round} ---`, 'system');
          document.getElementById('round-number').textContent = event.round;
          break;
      }
      
      // Refresh state
      fetchRoomState();
    }

    // ========================================
    // LOG & EFFECTS
    // ========================================
    function addLogEntry(text, type = 'system') {
      const log = document.getElementById('log-content');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.dataset.type = type;
      
      const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      entry.innerHTML = `
        <div class="log-time">${time}</div>
        <div class="log-text">${text}</div>
      `;
      
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      
      // Limit log size
      while (log.children.length > 100) {
        log.removeChild(log.firstChild);
      }
    }

    function filterLogs(filter) {
      document.querySelectorAll('.log-entry').forEach(entry => {
        if (filter === 'all') {
          entry.style.display = 'block';
        } else if (filter === 'combat') {
          entry.style.display = ['attack', 'damage', 'heal', 'death', 'critical'].includes(entry.dataset.type) ? 'block' : 'none';
        } else {
          entry.style.display = entry.dataset.type === filter ? 'block' : 'none';
        }
      });
    }

    function spawnDamageNumber(amount, type) {
      const container = document.getElementById('damage-numbers');
      const num = document.createElement('div');
      num.className = `damage-number ${type}`;
      num.textContent = type === 'heal' ? `+${amount}` : `-${amount}`;
      
      // Random position near center
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      num.style.left = `${centerX + (Math.random() - 0.5) * 200}px`;
      num.style.top = `${centerY + (Math.random() - 0.5) * 100}px`;
      
      container.appendChild(num);
      setTimeout(() => num.remove(), 1500);
    }

    function screenShake() {
      document.body.classList.add('screen-shake');
      setTimeout(() => document.body.classList.remove('screen-shake'), 500);
    }

    function showPhaseTransition(event) {
      const overlay = document.getElementById('phase-overlay');
      document.getElementById('phase-text').textContent = `PHASE ${event.phase}: ${event.phaseName.toUpperCase()}`;
      document.getElementById('phase-desc').textContent = event.description;
      
      overlay.classList.add('active');
      screenShake();
      
      setTimeout(() => overlay.classList.remove('active'), 3500);
    }

    function showVictory(event) {
      const overlay = document.getElementById('victory-overlay');
      overlay.classList.add('active');
      addLogEntry('üéâ VICTORY! The Dreadnought has been defeated!', 'system');
    }

    function showDefeat(event) {
      const overlay = document.getElementById('defeat-overlay');
      document.getElementById('defeat-message').textContent = event.message || "The Dreadnought's Depths claims more souls...";
      overlay.classList.add('active');
      addLogEntry('üíÄ DEFEAT! The party has fallen...', 'system');
    }

    function closeOverlays() {
      document.getElementById('victory-overlay').classList.remove('active');
      document.getElementById('defeat-overlay').classList.remove('active');
      window.location.href = '/';
    }

    // ========================================
    // ACTIONS (for player mode)
    // ========================================
    async function sendAction(action) {
      if (!currentCapstoneId || !API_KEY) return;
      
      const data = await fetchAPI(`/${currentCapstoneId}/action`, {
        method: 'POST',
        body: JSON.stringify({ action })
      });
      
      if (data.success) {
        addLogEntry(`Action: ${action}`, 'system');
      } else {
        addLogEntry(`Error: ${data.error}`, 'system');
      }
    }

    // Handle window resize
    window.addEventListener('resize', () => {
      if (currentCombat) {
        renderHexGrid(currentCombat);
      }
    });
  </script>
</body>
</html>
