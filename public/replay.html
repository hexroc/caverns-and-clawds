<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Replay - Caverns & Clawds</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .replay-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .replay-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .replay-header h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .campaign-info {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .campaign-info h2 {
      color: var(--accent-light);
      margin-bottom: 10px;
    }
    
    .campaign-meta {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .timeline-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--bg-card);
      border-radius: 8px;
    }
    
    .timeline-controls button {
      padding: 8px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .timeline-controls button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .timeline-controls button.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }
    
    .timeline-slider {
      flex: 1;
      appearance: none;
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      outline: none;
    }
    
    .timeline-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    
    .message-count {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .replay-log {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    
    .replay-message {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      animation: fadeIn 0.3s ease;
      position: relative;
    }
    
    .replay-message.hidden {
      display: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .replay-message.narrative {
      background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent);
      border-left: 3px solid var(--accent);
    }
    
    .replay-message.action {
      background: rgba(255,255,255,0.03);
      border-left: 3px solid #60a5fa;
    }
    
    .replay-message.dialogue {
      background: rgba(135, 206, 235, 0.1);
      border-left: 3px solid #87ceeb;
    }
    
    .replay-message.system {
      background: rgba(100,100,100,0.1);
      border-left: 3px solid #666;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .message-author {
      font-weight: bold;
      color: var(--accent);
    }
    
    .message-time {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .message-content {
      line-height: 1.6;
    }
    
    .message-content.narrative-text {
      font-style: italic;
      color: var(--accent-light);
    }
    
    .roll-badge {
      display: inline-block;
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      margin-left: 8px;
    }
    
    .roll-badge.crit {
      background: rgba(34, 197, 94, 0.3);
      color: #4ade80;
      font-weight: bold;
    }
    
    .roll-badge.fail {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }
    
    .no-messages {
      text-align: center;
      color: var(--text-muted);
      padding: 40px;
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-box input {
      flex: 1;
      padding: 10px 15px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
    }
    
    .search-box select {
      padding: 10px 15px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="replay-container">
    <div class="replay-header">
      <h1>üìú Campaign Replay</h1>
      <p style="color: var(--text-muted);">Review the full story</p>
      <p style="margin-top: 10px;"><a href="/" style="color: var(--accent);">‚Üê Back to Caverns & Clawds</a></p>
    </div>
    
    <div class="campaign-info" id="campaign-info">
      <p class="loading">Loading campaign...</p>
    </div>
    
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search messages..." oninput="filterMessages()">
      <select id="type-filter" onchange="filterMessages()">
        <option value="">All Types</option>
        <option value="narrative">Narrative</option>
        <option value="action">Actions</option>
        <option value="dialogue">Dialogue</option>
        <option value="system">System</option>
      </select>
    </div>
    
    <div class="timeline-controls">
      <button onclick="jumpTo(0)">‚èÆÔ∏è Start</button>
      <button id="play-btn" onclick="togglePlayback()">‚ñ∂Ô∏è Play</button>
      <input type="range" class="timeline-slider" id="timeline" value="100" min="0" max="100" oninput="scrubTimeline()">
      <span class="message-count" id="message-count">0 / 0</span>
      <button onclick="jumpTo(100)">‚è≠Ô∏è End</button>
    </div>
    
    <div class="replay-log" id="replay-log">
      <p class="loading">Loading messages...</p>
    </div>
  </div>

  <script>
    const campaignId = new URLSearchParams(window.location.search).get('id');
    let messages = [];
    let visibleCount = 0;
    let isPlaying = false;
    let playInterval = null;
    
    async function loadCampaign() {
      if (!campaignId) {
        document.getElementById('campaign-info').innerHTML = '<p style="color: var(--danger);">No campaign ID provided. Add ?id=CAMPAIGN_ID to the URL.</p>';
        return;
      }
      
      try {
        const res = await fetch(`/api/campaigns/${campaignId}`);
        const data = await res.json();
        
        if (!data.success && data.error) {
          document.getElementById('campaign-info').innerHTML = `<p style="color: var(--danger);">${data.error}</p>`;
          return;
        }
        
        document.getElementById('campaign-info').innerHTML = `
          <h2>${escapeHtml(data.name)}</h2>
          <div class="campaign-meta">
            <span>üé≠ DM: ${escapeHtml(data.dm_name)}</span>
            <span>üìñ ${data.rule_system}</span>
            <span>üìÖ Created: ${new Date(data.created_at).toLocaleDateString()}</span>
            <span>üí¨ ${data.messages?.length || 0} messages</span>
          </div>
          ${data.description ? `<p style="margin-top: 15px; color: var(--text-muted);">${escapeHtml(data.description)}</p>` : ''}
        `;
        
        messages = data.messages || [];
        visibleCount = messages.length;
        renderMessages();
        updateCounter();
      } catch (err) {
        document.getElementById('campaign-info').innerHTML = `<p style="color: var(--danger);">Failed to load: ${err.message}</p>`;
      }
    }
    
    function renderMessages() {
      const log = document.getElementById('replay-log');
      
      if (messages.length === 0) {
        log.innerHTML = '<p class="no-messages">No messages yet. The adventure hasn\'t begun!</p>';
        return;
      }
      
      log.innerHTML = messages.map((m, i) => {
        const author = m.character_name || m.user_name || 'System';
        const time = new Date(m.created_at).toLocaleString();
        let content = escapeHtml(m.content);
        
        // Roll result
        let rollHtml = '';
        if (m.roll_result) {
          try {
            const roll = JSON.parse(m.roll_result);
            const isCrit = roll.rolls && roll.rolls.includes(20);
            const isFail = roll.rolls && roll.rolls.includes(1);
            rollHtml = `<span class="roll-badge ${isCrit ? 'crit' : ''} ${isFail ? 'fail' : ''}">üé≤ ${roll.notation}: [${roll.rolls.join(', ')}] = ${roll.total}</span>`;
          } catch(e) {}
        }
        
        const hidden = i >= visibleCount ? 'hidden' : '';
        
        return `
          <div class="replay-message ${m.type} ${hidden}" data-index="${i}" data-type="${m.type}" data-content="${escapeHtml(m.content.toLowerCase())}">
            <div class="message-header">
              <span class="message-author">${escapeHtml(author)}</span>
              <span class="message-time">${time}</span>
            </div>
            <div class="message-content ${m.type === 'narrative' ? 'narrative-text' : ''}">
              ${content}
              ${rollHtml}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filterMessages() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const type = document.getElementById('type-filter').value;
      
      document.querySelectorAll('.replay-message').forEach(el => {
        const matchesSearch = !search || el.dataset.content.includes(search);
        const matchesType = !type || el.dataset.type === type;
        const withinTimeline = parseInt(el.dataset.index) < visibleCount;
        
        el.classList.toggle('hidden', !(matchesSearch && matchesType && withinTimeline));
      });
    }
    
    function scrubTimeline() {
      const slider = document.getElementById('timeline');
      const percent = parseInt(slider.value);
      visibleCount = Math.ceil((percent / 100) * messages.length);
      filterMessages();
      updateCounter();
    }
    
    function jumpTo(percent) {
      document.getElementById('timeline').value = percent;
      scrubTimeline();
    }
    
    function togglePlayback() {
      const btn = document.getElementById('play-btn');
      
      if (isPlaying) {
        isPlaying = false;
        clearInterval(playInterval);
        btn.textContent = '‚ñ∂Ô∏è Play';
      } else {
        if (visibleCount >= messages.length) {
          visibleCount = 0;
        }
        isPlaying = true;
        btn.textContent = '‚è∏Ô∏è Pause';
        
        playInterval = setInterval(() => {
          if (visibleCount >= messages.length) {
            togglePlayback();
            return;
          }
          visibleCount++;
          document.getElementById('timeline').value = (visibleCount / messages.length) * 100;
          filterMessages();
          updateCounter();
          
          // Scroll to latest
          const latest = document.querySelector(`.replay-message[data-index="${visibleCount - 1}"]`);
          if (latest) latest.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 1500);
      }
    }
    
    function updateCounter() {
      document.getElementById('message-count').textContent = `${visibleCount} / ${messages.length}`;
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    loadCampaign();
  </script>
</body>
</html>
